name: CI/CD Deployment

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'

env:
  DOCKER_IMAGE_NAME: git-visualize-engine-backend
  DOCKER_COMPOSE_FILE: docker-compose.vercel.yml

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          BACKEND_ENV_FILE: ${{ secrets.BACKEND_ENV_FILE }}
        run: |
          missing=()
          [ -z "${DEPLOY_HOST}" ] && missing+=("DEPLOY_HOST")
          [ -z "${DEPLOY_USER}" ] && missing+=("DEPLOY_USER")
          [ -z "${DEPLOY_SSH_KEY}" ] && missing+=("DEPLOY_SSH_KEY")
          [ -z "${BACKEND_ENV_FILE}" ] && missing+=("BACKEND_ENV_FILE")

          if [ ${#missing[@]} -ne 0 ]; then
            echo "❌ Missing required secrets: ${missing[*]}"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: Check Docker credentials
        id: check_docker
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          if [ -n "${DOCKER_USERNAME}" ] && [ -n "${DOCKER_PASSWORD}" ]; then
            echo "has_creds=true" >> $GITHUB_OUTPUT
          else
            echo "has_creds=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub (if needed)
        if: ${{ steps.check_docker.outputs.has_creds == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        if: ${{ steps.check_docker.outputs.has_creds == 'true' }}
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ steps.check_docker.outputs.has_creds }}" = "true" ]; then
            echo "tags=${{ steps.meta.outputs.tags }}" >> $GITHUB_OUTPUT
            echo "labels=${{ steps.meta.outputs.labels }}" >> $GITHUB_OUTPUT
          else
            echo "tags=${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "labels=" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src/backend
          file: ./src/backend/Dockerfile
          push: ${{ steps.check_docker.outputs.has_creds == 'true' }}
          tags: ${{ steps.image-tag.outputs.tags }}
          labels: ${{ steps.image-tag.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            IMAGE_VERSION=${{ github.sha }}

      - name: Prepare deployment
        run: |
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "GIT_COMMIT=${{ github.sha }}" >> $GITHUB_ENV

      - name: Create deployment package
        run: |
          mkdir -p deploy/src/backend
          cp ${{ env.DOCKER_COMPOSE_FILE }} deploy/
          cp -r nginx deploy/ || true
          echo "Deployment package created"

      - name: Create backend env file
        run: |
          if [ -z "${{ secrets.BACKEND_ENV_FILE }}" ]; then
            echo "❌ Missing BACKEND_ENV_FILE secret"
            exit 1
          fi
          mkdir -p deploy/src/backend
          printf '%s\n' "${{ secrets.BACKEND_ENV_FILE }}" > deploy/src/backend/.env.production
          chmod 600 deploy/src/backend/.env.production

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "deploy/*"
          target: ${{ secrets.DEPLOY_PATH || '/opt/git-visualize-engine' }}
          strip_components: 0

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/git-visualize-engine' }}"
            COMPOSE_FILE="${{ env.DOCKER_COMPOSE_FILE }}"
            
            cd "$DEPLOY_PATH"
            
            # Set environment variables
            export IMAGE_TAG=${{ github.sha }}
            export BUILD_DATE=${{ env.BUILD_DATE }}
            export GIT_COMMIT=${{ env.GIT_COMMIT }}
            
            # Pull latest image if using Docker Hub
            if [ -n "$DOCKER_USERNAME" ]; then
              echo "Pulling latest Docker image..."
              docker pull "$DOCKER_USERNAME/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}" || true
              docker pull "$DOCKER_USERNAME/${{ env.DOCKER_IMAGE_NAME }}:latest" || true
            fi
            
            # Stop existing containers gracefully
            echo "Stopping existing containers..."
            docker-compose -f "$COMPOSE_FILE" down --timeout 30 || true
            
            # Start services with new image
            echo "Starting services with new image..."
            docker-compose -f "$COMPOSE_FILE" up -d --build --remove-orphans
            
            # Wait for services to be healthy
            echo "Waiting for services to be healthy..."
            timeout 120 bash -c 'until docker-compose -f "$COMPOSE_FILE" ps | grep -q "Up (healthy)"; do sleep 5; done' || true
            
            # Clean up old images
            echo "Cleaning up old Docker images..."
            docker image prune -f --filter "until=168h" || true
            
            # Show service status
            echo "Service status:"
            docker-compose -f "$COMPOSE_FILE" ps
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/git-visualize-engine' }}"
            COMPOSE_FILE="${{ env.DOCKER_COMPOSE_FILE }}"
            
            cd "$DEPLOY_PATH"
            
            # Check backend health
            echo "Checking backend health..."
            for i in {1..10}; do
              if docker-compose -f "$COMPOSE_FILE" exec -T backend node -e "require('http').get('http://localhost:8000/docs', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1));" 2>/dev/null; then
                echo "✅ Backend is healthy"
                exit 0
              fi
              echo "Waiting for backend... ($i/10)"
              sleep 6
            done
            
            echo "❌ Backend health check failed"
            docker-compose -f "$COMPOSE_FILE" logs --tail=50 backend
            exit 1
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Commit: ${{ github.sha }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Author: ${{ github.event.head_commit.author.name }}"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi

